<!doctype html>
<html>

<head>
  <title>Food Analyzer</title>
</head>

<script src="./audiobuffer-to-wav.js"> </script>

<script async defer>
  // 3 second clips
  const clipSize = 3000;
  const ws = new WebSocket(`ws://localhost:8765`)
  const audioContext = new AudioContext();
  let mediaRecorders;
  let oneSecChunks = []


  async function startRecording() {
    const stream = await navigator.mediaDevices
      .getUserMedia({
        audio: true,
      },
      );
    const source = audioContext.createMediaStreamSource(stream);
    const mediaRecorder =
      new MediaRecorder(source.mediaStream);


    mediaRecorder.ondataavailable = handleAudioData;
    while (true) {
      mediaRecorder.start();
      await sleep(1000);
      mediaRecorder.stop()
    }

    // const audioContext = new AudioContext();
    // const source = audioContext.createMediaStreamSource(stream);
    // const analyser = audioContext.createAnalyser();
    // analyser.fftSize = 256;
    // source.connect(analyser);

  }

  async function sleep(ms) {
    return new Promise((resolve) => {
      setTimeout(() => resolve(), ms)
    })
  }

  // function createAudioHandler(mediaRecorder) {
  async function handleAudioData(event) {
    const arrayBuffer = await event.data.arrayBuffer();
    const chunk = await audioContext.decodeAudioData(arrayBuffer);
    oneSecChunks.push(chunk);
    if (oneSecChunks.length === 3) {
      const audioClip = concatBuffer(oneSecChunks);
      const wav = audioBufferToWav(audioClip)
      ws.send(wav);
      console.log('Sent audioclip wav', audioClip);
      oneSecChunks.shift();
    }
  }

  function concatBuffer(buffers) {
    var buflengh = buffers.length;
    var channels = [];
    var totalDuration = 0;
    for (var a = 0; a < buflengh; a++) {
      channels.push(buffers[a].numberOfChannels);// Store all number of channels to choose the lowest one after
      totalDuration += buffers[a].duration;// Get the total duration of the new buffer when every buffer will be added/concatenated
    }
    var numberOfChannels = channels.reduce(function (a, b) { return Math.min(a, b); });// The lowest value contained in the array channels
    var tmp = audioContext.createBuffer(numberOfChannels, audioContext.sampleRate * totalDuration, audioContext.sampleRate);// Create new buffer
    for (var b = 0; b < numberOfChannels; b++) {
      var channel = tmp.getChannelData(b);
      var dataIndex = 0;
      for (var c = 0; c < buflengh; c++) {
        channel.set(buffers[c].getChannelData(b), dataIndex);
        dataIndex += buffers[c].length;// Next position where we should store the next buffer values
      }
    }
    return tmp;
  }


  function handleClick() {
    const btn = document.getElementById("startBtn");
    btn.setAttribute('disabled', 'true');
    startRecording();
  }

</script>

<body>
  <div class="container">
    <button id="startBtn" onclick="handleClick()">Start recording</button>
  </div>
</body>


<style>
  #startBtn {
    width: 10rem;
    height: 5rem;
  }

  .container {
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>

</html>