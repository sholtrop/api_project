<!doctype html>
<html>

<head>
    <title>Food Analyzer</title>
</head>

<script async defer>
    const ws = new WebSocket(`ws://localhost:8765`)

    async function startRecording() {
        console.debug('Start recording')
        const stream = await navigator.mediaDevices
            .getUserMedia({
                audio: true,
            },
            );
        const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

        const audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);

        const btn = document.getElementById("startBtn");
        btn.setAttribute('disabled', 'true');
        mediaRecorder.ondataavailable = handleAudioData;
        mediaRecorder.start(1000);

    }

    const reader = new FileReader();
    function handleAudioData(event) {
        if (event.data.size > 0) {
            reader.onload = function (e) {
                const audioData = new Int8Array(e.target.result);
                const isSilent = isAudioSilent(audioData);

                if (!isSilent) {
                    // Process non-silent audio data (send to server, etc.)
                    console.log('Non-silent audio data:', audioData);

                    ws.send(audioData);
                };

            }
        };
        reader.readAsArrayBuffer(event.data);
    }

    const silenceThreshold = 50;
    function isAudioSilent(audioData) {
        const sum = audioData.reduce((acc, value) => acc + Math.abs(value), 0);
        const avg = sum / audioData.length;
        console.log({ avg })
        // Adjust the threshold based on your requirements
        return avg < silenceThreshold;
    }
</script>

<body>
    <div class="container">
        <button id="startBtn" onclick="startRecording()">Start recording</button>
    </div>
</body>


<style>
    #startBtn {
        width: 10rem;
        height: 5rem;
    }

    .container {
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

</html>